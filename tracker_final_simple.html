<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth Tracker - Cloud Synced</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .auth-container h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .auth-form button:hover {
            background: #5568d3;
        }
        
        .toggle-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .toggle-btn:hover {
            background: #f0f0f0;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        #app {
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            margin: 0 0 10px 0;
        }
        
        .header-left p {
            margin: 0;
            opacity: 0.9;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-email {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #f0f0f0;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .sheet {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sheet.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .add-row {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .add-row:hover {
            background: #5568d3;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .metric {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric.negative {
            color: #dc3545;
        }
        
        .metric.positive {
            color: #28a745;
        }
        
        .category-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .instructions ul {
            margin: 10px 0;
        }
        
        .instructions li {
            margin: 5px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sync-status.syncing {
            background: #ffc107;
            color: #333;
        }
        
        .sync-status.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div id="auth" class="auth-container">
        <h1>üí∞ Net Worth Tracker</h1>
        
        <div class="error-message" id="authError"></div>
        <div class="success-message" id="authSuccess"></div>
        
        <div id="loginForm" class="auth-form">
            <h2 style="text-align: center; color: #333;">Sign In</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button id="loginBtn">Sign In</button>
            <button class="toggle-btn" id="showSignupBtn">Create New Account</button>
        </div>
        
        <div id="signupForm" class="auth-form" style="display: none;">
            <h2 style="text-align: center; color: #333;">Create Account</h2>
            <input type="email" id="signupEmail" placeholder="Email" required>
            <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" required>
            <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password" required>
            <button id="signupBtn">Create Account</button>
            <button class="toggle-btn" id="showLoginBtn">Back to Sign In</button>
        </div>
    </div>

    <div id="app">
        <div class="header">
            <div class="header-left">
                <h1>üí∞ Net Worth Tracker</h1>
                <p>Cloud synced across all your devices</p>
            </div>
            <div class="user-info">
                <div class="user-email" id="userEmail"></div>
                <button class="logout-btn" id="logoutBtn">Sign Out</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-sheet="dashboard">üìä Dashboard</button>
            <button class="tab" data-sheet="transactions">üí≥ Transactions</button>
            <button class="tab" data-sheet="balances">üè¶ Account Balances</button>
            <button class="tab" data-sheet="spending">üìà Spending Analysis</button>
        </div>

        <div id="dashboard" class="sheet active">
            <h2>Net Worth Overview</h2>
            
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Total Net Worth</h3>
                    <div class="metric" id="totalNetWorth">$0.00</div>
                </div>
                
                <div class="card">
                    <h3>Liquid Assets</h3>
                    <div class="metric" id="liquidAssets">$0.00</div>
                    <small style="color: #666;">Checking + Savings - Credit Cards</small>
                </div>
                
                <div class="card">
                    <h3>Investment Assets</h3>
                    <div class="metric positive" id="investmentAssets">$0.00</div>
                    <small style="color: #666;">Retirement Accounts</small>
                </div>
                
                <div class="card">
                    <h3>Total Debt</h3>
                    <div class="metric negative" id="totalDebt">$0.00</div>
                    <small style="color: #666;">Credit Card Balances</small>
                </div>
            </div>

            <div class="card">
                <h3>Monthly Spending (Current Month)</h3>
                <div id="monthlySpending" style="margin-top: 15px;">
                    <div class="loading">Loading...</div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #667eea;">
                    <div class="category-row">
                        <strong>Total Spending</strong>
                        <strong id="totalSpending">$0.00</strong>
                    </div>
                </div>
            </div>
        </div>

        <div id="transactions" class="sheet">
            <h2>Transactions</h2>
            
            <div class="instructions">
                <h3>üí° How to use:</h3>
                <ul>
                    <li><strong>Purchase:</strong> Any spending from a card or debit account</li>
                    <li><strong>Transfer:</strong> Moving money between YOUR accounts (paying off credit card, moving to savings)</li>
                    <li><strong>Income:</strong> Money coming in (paycheck, refund, etc.)</li>
                </ul>
                <p><strong>Important:</strong> Mark credit card payments as "Transfer" so they don't count as spending!</p>
            </div>
            
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Account</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Notes</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody">
                    <tr><td colspan="7" class="loading">Loading transactions...</td></tr>
                </tbody>
            </table>
            <button class="add-row" id="addTransactionBtn">+ Add Transaction</button>
        </div>

        <div id="balances" class="sheet">
            <h2>Account Balances</h2>
            
            <div class="instructions">
                <h3>üí° How it works:</h3>
                <ul>
                    <li><strong>First time (Feb 1):</strong> Enter your starting balances - these get saved behind the scenes</li>
                    <li><strong>Current Balance:</strong> Automatically calculated from all your transactions</li>
                    <li><strong>Last Verified:</strong> When you last confirmed it matches your bank statement</li>
                    <li><strong>Monthly check:</strong> Compare Current Balance to your bank - if they don't match, you missed logging something!</li>
                </ul>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Account Name</th>
                        <th>Current Balance<br><small>(Auto-calculated)</small></th>
                        <th>Last Verified</th>
                    </tr>
                </thead>
                <tbody id="balancesBody">
                    <tr><td colspan="3" class="loading">Loading balances...</td></tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
                <strong>üí° First time setup:</strong> Click "Set Starting Balances" below to enter your Feb 1 balances.
                <br><br>
                <button class="add-row" onclick="showStartingBalanceModal()" id="setStartingBtn">Set Starting Balances</button>
            </div>
        </div>
        
        <!-- Starting Balance Modal -->
        <div id="startingBalanceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; max-width: 600px; margin: 100px auto; padding: 30px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">
                <h2>Set Starting Balances (Feb 1, 2026)</h2>
                <p>Enter your account balances as of Feb 1, 2026. These will be used to calculate your current balances.</p>
                
                <div id="startingBalanceInputs"></div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="add-row" onclick="saveStartingBalances()">Save Starting Balances</button>
                    <button class="delete-btn" onclick="closeStartingBalanceModal()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="spending" class="sheet">
            <h2>Spending Analysis</h2>
            
            <div class="card">
                <h3>Spending by Category (All Time)</h3>
                <div id="categoryBreakdown">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>Recent Transactions</h3>
                <div id="recentTransactions">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="sync-status" id="syncStatus">Synced ‚úì</div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://dxeunkqnogqbnowmcqii.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_F4i-Fz8IC6oKvt8b2IqKYg_YONHsfTi';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let transactions = [];
        let balances = {};
        let authDiv, appDiv, loginForm, signupForm, authError, authSuccess;
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // DOM Elements
            authDiv = document.getElementById('auth');
            appDiv = document.getElementById('app');
            loginForm = document.getElementById('loginForm');
            signupForm = document.getElementById('signupForm');
            authError = document.getElementById('authError');
            authSuccess = document.getElementById('authSuccess');
            
            // Event Listeners - using addEventListener instead of onclick
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('signupBtn').addEventListener('click', handleSignup);
            document.getElementById('showSignupBtn').addEventListener('click', showSignup);
            document.getElementById('showLoginBtn').addEventListener('click', showLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('addTransactionBtn').addEventListener('click', addTransaction);
            
            console.log('Event listeners attached!');
            
            // Tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const sheetName = this.getAttribute('data-sheet');
                    showSheet(sheetName);
                });
            });
            
            // Check if user is already logged in
            checkAuth();
        });
        
        // Authentication functions
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            hideMessages();
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                showError(error.message);
            } else {
                currentUser = data.user;
                showApp();
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            
            hideMessages();
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password
            });
            
            if (error) {
                showError(error.message);
            } else {
                showSuccess('Account created! Please check your email to confirm your account, then sign in.');
                setTimeout(() => showLogin(), 3000);
            }
        }
        
        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            authDiv.style.display = 'block';
            appDiv.style.display = 'none';
            showLogin();
        }
        
        function showLogin() {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            hideMessages();
        }
        
        function showSignup() {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            hideMessages();
        }
        
        function showError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }
        
        function showSuccess(message) {
            authSuccess.textContent = message;
            authSuccess.style.display = 'block';
        }
        
        function hideMessages() {
            authError.style.display = 'none';
            authSuccess.style.display = 'none';
        }
        
        function showSyncStatus(message, type = 'success') {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = 'sync-status ' + type;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 2000);
            }
        }
        
        async function showApp() {
            authDiv.style.display = 'none';
            appDiv.style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
            
            await loadData();
        }
        
        // Data management functions
        async function loadData() {
            showSyncStatus('Loading...', 'syncing');
            
            try {
                // Load transactions
                const { data: txnData, error: txnError } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: false });
                
                if (txnError) throw txnError;
                
                transactions = txnData || [];
                renderTransactions();
                
                // Load balances
                const { data: balData, error: balError } = await supabaseClient
                    .from('balances')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (balError && balError.code !== 'PGRST116') throw balError;
                
                balances = balData || {};
                renderBalances();
                
                updateDashboard();
                showSyncStatus('Synced ‚úì');
            } catch (error) {
                console.error('Error loading data:', error);
                showSyncStatus('Sync error', 'error');
            }
        }
        
        function renderTransactions() {
            const tbody = document.getElementById('transactionsBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = createTransactionRow();
                addTransactionListeners(tbody.rows[0]);
            } else {
                tbody.innerHTML = transactions.map(txn => createTransactionRow(txn)).join('');
                tbody.querySelectorAll('tr').forEach(addTransactionListeners);
            }
        }
        
        function createTransactionRow(txn = null) {
            const id = txn ? txn.id : '';
            const date = txn ? txn.date : new Date().toISOString().split('T')[0];
            const account = txn ? txn.account : 'Debit';
            const type = txn ? txn.type : 'Purchase';
            const category = txn ? txn.category : 'Misc';
            const amount = txn ? txn.amount : '';
            const notes = txn ? txn.notes || '' : '';
            
            return `<tr data-id="${id}">
                <td><input type="date" class="txn-date" value="${date}"></td>
                <td><select class="txn-account">
                    <option value="Debit" ${account === 'Debit' ? 'selected' : ''}>East Cambridge Savings Bank</option>
                    <option value="Credit1" ${account === 'Credit1' ? 'selected' : ''}>Bank of America</option>
                    <option value="Credit2" ${account === 'Credit2' ? 'selected' : ''}>Apple Card</option>
                    <option value="Credit3" ${account === 'Credit3' ? 'selected' : ''}>Capital One</option>
                    <option value="HYSA" ${account === 'HYSA' ? 'selected' : ''}>All America Bank HYSA</option>
                </select></td>
                <td><select class="txn-type">
                    <option value="Purchase" ${type === 'Purchase' ? 'selected' : ''}>Purchase</option>
                    <option value="Transfer" ${type === 'Transfer' ? 'selected' : ''}>Transfer</option>
                    <option value="Income" ${type === 'Income' ? 'selected' : ''}>Income</option>
                </select></td>
                <td><select class="txn-category">
                    <option value="Groceries" ${category === 'Groceries' ? 'selected' : ''}>Groceries</option>
                    <option value="Eating Out" ${category === 'Eating Out' ? 'selected' : ''}>Eating Out</option>
                    <option value="Rent/Utilities" ${category === 'Rent/Utilities' ? 'selected' : ''}>Rent/Utilities</option>
                    <option value="Personal Care" ${category === 'Personal Care' ? 'selected' : ''}>Personal Care</option>
                    <option value="Clothing" ${category === 'Clothing' ? 'selected' : ''}>Clothing</option>
                    <option value="Transportation" ${category === 'Transportation' ? 'selected' : ''}>Transportation</option>
                    <option value="Vacation" ${category === 'Vacation' ? 'selected' : ''}>Vacation</option>
                    <option value="Entertainment" ${category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                    <option value="Subscriptions" ${category === 'Subscriptions' ? 'selected' : ''}>Subscriptions</option>
                    <option value="Household" ${category === 'Household' ? 'selected' : ''}>Household</option>
                    <option value="Gifts/Charity" ${category === 'Gifts/Charity' ? 'selected' : ''}>Gifts/Charity</option>
                    <option value="Pets" ${category === 'Pets' ? 'selected' : ''}>Pets</option>
                    <option value="Misc" ${category === 'Misc' ? 'selected' : ''}>Misc</option>
                    <option value="Transfer/Payment" ${category === 'Transfer/Payment' ? 'selected' : ''}>Transfer/Payment</option>
                </select></td>
                <td><input type="number" class="txn-amount" step="0.01" value="${amount}" placeholder="0.00"></td>
                <td><input type="text" class="txn-notes" value="${notes}" placeholder="Description"></td>
                <td><button class="delete-btn delete-transaction-btn">Delete</button></td>
            </tr>`;
        }
        
        function addTransactionListeners(row) {
            row.querySelectorAll('input, select').forEach(elem => {
                elem.addEventListener('change', () => saveTransaction(row));
            });
            
            row.querySelector('.delete-transaction-btn').addEventListener('click', function() {
                deleteTransaction(row);
            });
        }
        
        async function saveTransaction(row) {
            const id = row.dataset.id;
            const txnData = {
                user_id: currentUser.id,
                date: row.querySelector('.txn-date').value,
                account: row.querySelector('.txn-account').value,
                type: row.querySelector('.txn-type').value,
                category: row.querySelector('.txn-category').value,
                amount: parseFloat(row.querySelector('.txn-amount').value) || 0,
                notes: row.querySelector('.txn-notes').value
            };
            
            if (!txnData.date || txnData.amount === 0) return;
            
            showSyncStatus('Saving...', 'syncing');
            
            try {
                if (id) {
                    // Update existing
                    const { error } = await supabaseClient
                        .from('transactions')
                        .update(txnData)
                        .eq('id', id);
                    
                    if (error) throw error;
                } else {
                    // Insert new
                    const { data, error } = await supabaseClient
                        .from('transactions')
                        .insert(txnData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    row.dataset.id = data.id;
                    transactions.push(data);
                }
                
                updateDashboard();
                showSyncStatus('Synced ‚úì');
            } catch (error) {
                console.error('Error saving transaction:', error);
                showSyncStatus('Sync error', 'error');
            }
        }
        
        function addTransaction() {
            const tbody = document.getElementById('transactionsBody');
            const newRow = tbody.insertRow(0);
            newRow.innerHTML = createTransactionRow();
            addTransactionListeners(newRow);
        }
        
        async function deleteTransaction(row) {
            const id = row.dataset.id;
            
            if (!id) {
                row.remove();
                return;
            }
            
            if (!confirm('Delete this transaction?')) return;
            
            showSyncStatus('Deleting...', 'syncing');
            
            try {
                const { error } = await supabaseClient
                    .from('transactions')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                row.remove();
                transactions = transactions.filter(t => t.id !== id);
                await loadData();
                showSyncStatus('Synced ‚úì');
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showSyncStatus('Delete error', 'error');
            }
        }
        
        function renderBalances() {
            const tbody = document.getElementById('balancesBody');
            
            const accounts = [
                { type: 'Checking', name: 'East Cambridge Savings Bank', key: 'debit', color: '', isCredit: false },
                { type: 'Savings', name: 'All America Bank HYSA', key: 'hysa', color: '', isCredit: false },
                { type: 'Credit Card', name: 'Bank of America', key: 'credit1', color: '#fff3cd', isCredit: true },
                { type: 'Credit Card', name: 'Apple Card', key: 'credit2', color: '#fff3cd', isCredit: true },
                { type: 'Credit Card', name: 'Capital One', key: 'credit3', color: '#fff3cd', isCredit: true },
                { type: 'Retirement', name: 'Edward Jones Roth IRA', key: 'roth', color: '#d4edda', isCredit: false },
                { type: 'Retirement', name: 'City of Cambridge Retirement', key: 'retirement', color: '#d4edda', isCredit: false }
            ];
            
            tbody.innerHTML = accounts.map(acc => {
                const startingBalance = balances[acc.key + '_previous'] || 0;
                const currentBalance = calculateBalance(acc.key, acc.isCredit, startingBalance);
                const lastVerified = balances[acc.key + '_date'] || '';
                
                return `
                <tr style="${acc.color ? `background: ${acc.color}` : ''}">
                    <td><strong>${acc.name}</strong></td>
                    <td style="font-weight: bold; font-size: 18px;">${formatCurrency(currentBalance)}</td>
                    <td><input type="date" class="date-input" data-key="${acc.key}" 
                        value="${lastVerified}"></td>
                </tr>
            `;
            }).join('');
            
            // Add event listeners to date inputs
            tbody.querySelectorAll('.date-input').forEach(input => {
                input.addEventListener('change', saveVerificationDate);
            });
            
            // Hide the starting balance button if balances are already set
            if (startingBalance > 0 || balances.debit_previous > 0) {
                const btn = document.getElementById('setStartingBtn');
                if (btn) btn.style.display = 'none';
            }
        }
        
        function showStartingBalanceModal() {
            const modal = document.getElementById('startingBalanceModal');
            const inputsDiv = document.getElementById('startingBalanceInputs');
            
            const accounts = [
                { name: 'East Cambridge Savings Bank', key: 'debit' },
                { name: 'All America Bank HYSA', key: 'hysa' },
                { name: 'Bank of America', key: 'credit1' },
                { name: 'Apple Card', key: 'credit2' },
                { name: 'Capital One', key: 'credit3' },
                { name: 'Edward Jones Roth IRA', key: 'roth' },
                { name: 'City of Cambridge Retirement', key: 'retirement' }
            ];
            
            inputsDiv.innerHTML = accounts.map(acc => `
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>${acc.name}</strong></label>
                    <input type="number" class="starting-input" data-key="${acc.key}" step="0.01" 
                        placeholder="0.00" style="width: 100%; padding: 10px; font-size: 16px;"
                        value="${balances[acc.key + '_previous'] || ''}">
                </div>
            `).join('');
            
            modal.style.display = 'block';
        }
        
        function closeStartingBalanceModal() {
            document.getElementById('startingBalanceModal').style.display = 'none';
        }
        
        async function saveStartingBalances() {
            const balanceData = {
                user_id: currentUser.id
            };
            
            document.querySelectorAll('.starting-input').forEach(input => {
                const key = input.getAttribute('data-key') + '_previous';
                balanceData[key] = parseFloat(input.value) || 0;
            });
            
            showSyncStatus('Saving...', 'syncing');
            
            try {
                const { error } = await supabaseClient
                    .from('balances')
                    .upsert(balanceData, { onConflict: 'user_id' });
                
                if (error) throw error;
                
                balances = { ...balances, ...balanceData };
                closeStartingBalanceModal();
                renderBalances();
                updateDashboard();
                showSyncStatus('Synced ‚úì');
            } catch (error) {
                console.error('Error saving starting balances:', error);
                showSyncStatus('Sync error', 'error');
            }
        }
        
        async function saveVerificationDate() {
            const balanceData = {
                user_id: currentUser.id
            };
            
            document.querySelectorAll('.date-input').forEach(input => {
                const key = input.getAttribute('data-key') + '_date';
                balanceData[key] = input.value || null;
            });
            
            showSyncStatus('Saving...', 'syncing');
            
            try {
                const { error } = await supabaseClient
                    .from('balances')
                    .upsert(balanceData, { onConflict: 'user_id' });
                
                if (error) throw error;
                
                balances = { ...balances, ...balanceData };
                showSyncStatus('Synced ‚úì');
            } catch (error) {
                console.error('Error saving verification date:', error);
                showSyncStatus('Sync error', 'error');
            }
        }
        
        function calculateBalance(accountKey, isCredit, startingBalance) {
            let calculated = startingBalance;
            
            // Map account keys to transaction account values
            const accountMap = {
                'debit': 'Debit',
                'hysa': 'HYSA',
                'credit1': 'Credit1',
                'credit2': 'Credit2',
                'credit3': 'Credit3',
                'roth': 'Roth',
                'retirement': 'Retirement'
            };
            
            const accountValue = accountMap[accountKey];
            
            // Calculate from ALL transactions since starting
            transactions.forEach(txn => {
                if (txn.account === accountValue) {
                    if (isCredit) {
                        // For credit cards: purchases increase balance (debt), payments decrease it
                        if (txn.type === 'Purchase') {
                            calculated += txn.amount;
                        } else if (txn.type === 'Transfer') {
                            calculated -= txn.amount; // Payment reduces debt
                        }
                    } else {
                        // For checking/savings/retirement: income increases, purchases and transfers decrease
                        if (txn.type === 'Income') {
                            calculated += txn.amount;
                        } else if (txn.type === 'Purchase' || txn.type === 'Transfer') {
                            calculated -= txn.amount;
                        }
                    }
                }
            });
            
            return calculated;
        }
        
        
        function updateDashboard() {
            // Get account balances
            const debit = balances.debit || 0;
            const hysa = balances.hysa || 0;
            const credit1 = balances.credit1 || 0;
            const credit2 = balances.credit2 || 0;
            const credit3 = balances.credit3 || 0;
            const roth = balances.roth || 0;
            const retirement = balances.retirement || 0;
            
            // Calculate totals
            const totalDebt = credit1 + credit2 + credit3;
            const liquidAssets = debit + hysa - totalDebt;
            const investmentAssets = roth + retirement;
            const totalNetWorth = liquidAssets + investmentAssets;
            
            // Update dashboard
            document.getElementById('totalNetWorth').textContent = formatCurrency(totalNetWorth);
            document.getElementById('liquidAssets').textContent = formatCurrency(liquidAssets);
            document.getElementById('investmentAssets').textContent = formatCurrency(investmentAssets);
            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
            
            // Calculate monthly spending
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const categoryTotals = {};
            let totalSpending = 0;
            
            transactions.forEach(txn => {
                if (txn.type === 'Purchase' && txn.date) {
                    const txnDate = new Date(txn.date);
                    if (txnDate.getMonth() === currentMonth && txnDate.getFullYear() === currentYear) {
                        categoryTotals[txn.category] = (categoryTotals[txn.category] || 0) + txn.amount;
                        totalSpending += txn.amount;
                    }
                }
            });
            
            // Update monthly spending display
            const monthlySpendingDiv = document.getElementById('monthlySpending');
            if (Object.keys(categoryTotals).length === 0) {
                monthlySpendingDiv.innerHTML = '<div class="category-row"><span>No purchases this month</span><span>$0.00</span></div>';
            } else {
                monthlySpendingDiv.innerHTML = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cat, amt]) => `
                        <div class="category-row">
                            <span>${cat}</span>
                            <span>${formatCurrency(amt)}</span>
                        </div>
                    `).join('');
            }
            
            document.getElementById('totalSpending').textContent = formatCurrency(totalSpending);
        }
        
        function showSheet(sheetName) {
            document.querySelectorAll('.sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sheetName).classList.add('active');
            document.querySelector(`[data-sheet="${sheetName}"]`).classList.add('active');
            
            if (sheetName === 'spending') {
                updateSpendingAnalysis();
            }
        }
        
        function updateSpendingAnalysis() {
            const categoryTotals = {};
            
            transactions.forEach(txn => {
                if (txn.type === 'Purchase' && txn.amount > 0) {
                    categoryTotals[txn.category] = (categoryTotals[txn.category] || 0) + txn.amount;
                }
            });
            
            // Update category breakdown
            const categoryDiv = document.getElementById('categoryBreakdown');
            if (Object.keys(categoryTotals).length === 0) {
                categoryDiv.innerHTML = '<div class="category-row"><span>No purchases yet</span><span>$0.00</span></div>';
            } else {
                const total = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
                categoryDiv.innerHTML = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cat, amt]) => {
                        const pct = ((amt / total) * 100).toFixed(1);
                        return `
                            <div class="category-row">
                                <span>${cat} <small style="color: #666;">(${pct}%)</small></span>
                                <span>${formatCurrency(amt)}</span>
                            </div>
                        `;
                    }).join('') + `
                        <div class="category-row" style="border-top: 2px solid #667eea; margin-top: 10px; padding-top: 10px;">
                            <strong>Total</strong>
                            <strong>${formatCurrency(total)}</strong>
                        </div>
                    `;
            }
            
            // Update recent transactions
            const recentDiv = document.getElementById('recentTransactions');
            if (transactions.length === 0) {
                recentDiv.innerHTML = '<div class="category-row"><span>No transactions yet</span></div>';
            } else {
                const recent = [...transactions]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);
                
                recentDiv.innerHTML = recent.map(txn => `
                    <div class="category-row">
                        <div>
                            <strong>${txn.date}</strong> - ${txn.category}
                            ${txn.notes ? `<br><small style="color: #666;">${txn.notes}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <strong>${formatCurrency(txn.amount)}</strong>
                            <br><small style="color: #666;">${txn.account}</small>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        // Check if user is already logged in
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            }
        }
    </script>
</body>
</html>